#
#  ======== makeunix ========
#  Makefile for this tree
#

include ./imports.mak

TIRTOS_REPOS = $(TIRTOS)/packages;$(SYSBIOS)/packages

MYXDC = $(XDCROOT)/xdc XDCPATH="$(CURDIR)/src;$(TIRTOS_REPOS);$(DRVLIB)"

JOBS = --jobs=4

.all-files: imports.mak .imports .exports .generated_files

# ======== .debug ========
# Echo build state variables
.debug:
	@echo "XDC          =" $(MYXDC)
	@echo "TIRTOS       =" $(TIRTOS)
	@echo "DRVLIB       =" $(DRVLIB)
	@echo "TIRTOS_REPOS =" "$(TIRTOS_REPOS)"

# ======== .exports ========
# Builds all packages and makes release archive files 
.exports: .local-release

# ======== .local-release ========
# Builds all packages and makes releases
.local-release:
	-@mkdir -p exports
	@echo "Building platforms ..."
	$(MYXDC) $(JOBS) release -P $(wildcard src/ti/platforms/*)
	@echo "Building packages ..."
	$(MYXDC) $(JOBS) release -Pr src
	@echo making energia closures ...
	-make -C src/bundles/energia all msp432LP/closure.zip cc3200LP/closure.zip
ifeq (xlibrary,$(USER))
	@echo pushing to energia.nu ...
	-cd src/bundles/energia && ./push.exp msp432LP/closure.zip MSP-EXP432P401R-closure.zip cc3200LP/closure.zip CC3200-LAUNCHXL-closure.zip
endif

# ======== .local-regress ========
# Test the packages in this tree
.regress: .local-regress
.local-regress: .imports
	$(MYXDC) test -Pr ./src

# ======== .clean ========
# Clean the entire tree
.clean: .local-clean

.local-clean:
	-rm -f .generated_files
	-rm -rf exports/
	-$(MYXDC) --jobs=4 clean -Pr ./src
	-make -C src/bundles/energia clean
